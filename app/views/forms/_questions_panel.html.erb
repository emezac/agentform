<%
  # Questions Panel Component
  # Main panel for managing form questions with drag-and-drop functionality
%>

<div class="flex-1 bg-gray-50 overflow-y-auto" data-controller="sortable form-builder">
  
  <!-- Questions Header -->
  <div class="bg-white border-b border-gray-200 px-6 py-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Questions</h2>
        <p class="text-sm text-gray-500 mt-1">
          <%= pluralize(@form.form_questions.count, 'question') %> â€¢ Drag to reorder
        </p>
      </div>
      
      <!-- Add Question Button -->
      <button data-action="click->form-builder#showAddQuestion"
              class="inline-flex items-center px-4 py-2 bg-ai-gradient text-white text-sm font-medium rounded-lg hover:opacity-90 transition-opacity">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Add Question
      </button>
    </div>
  </div>

  <!-- Questions List -->
  <div class="p-6">
    <% if @form.form_questions.any? %>
      <div id="questions-list" 
           data-sortable-target="container"
           data-sortable-url-value="<%= reorder_form_questions_path(@form) %>"
           class="space-y-4">
        
        <% @form.form_questions.ordered.each_with_index do |question, index| %>
          <%= render 'question_card', question: question, index: index %>
        <% end %>
      </div>
      
      <!-- Add Question at End -->
      <div class="mt-6 pt-6 border-t border-gray-200">
        <button data-action="click->form-builder#showAddQuestion"
                class="w-full flex items-center justify-center px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Another Question
        </button>
      </div>
      
    <% else %>
      <!-- Empty State -->
      <div class="text-center py-12">
        <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No questions yet</h3>
        <p class="text-gray-600 mb-6 max-w-md mx-auto">
          Start building your form by adding your first question. You can choose from various question types and enable AI features.
        </p>
        <button data-action="click->form-builder#showAddQuestion"
                class="inline-flex items-center px-6 py-3 bg-ai-gradient text-white text-sm font-medium rounded-lg hover:opacity-90 transition-opacity">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Add Your First Question
        </button>
      </div>
    <% end %>
  </div>
</div>

<!-- Question Card Partial -->
<% content_for :question_card do %>
  <div class="question-card bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 group"
       data-sortable-target="item"
       data-question-id="<%= question.id %>"
       data-controller="question-card">
    
    <!-- Question Header -->
    <div class="flex items-start space-x-3">
      <!-- Drag Handle & Number -->
      <div class="flex items-center space-x-2 text-gray-400">
        <span class="text-sm font-medium w-6 text-center"><%= index + 1 %></span>
        <svg class="w-4 h-4 cursor-grab" data-sortable-target="handle">
          <path fill="currentColor" d="M3 7h2v2H3V7zm0 4h2v2H3v-2zm4-4h2v2H7V7zm0 4h2v2H7v-2zm4-4h2v2h-2V7zm0 4h2v2h-2v-2z"/>
        </svg>
      </div>
      
      <!-- Question Content -->
      <div class="flex-1 min-w-0">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="font-medium text-gray-900 mb-1 truncate">
              <%= question.title.present? ? question.title : "Untitled Question" %>
            </h3>
            <div class="flex items-center space-x-3 text-sm text-gray-500">
              <span class="px-2 py-1 bg-gray-100 rounded text-xs font-medium">
                <%= question.question_type.humanize %>
              </span>
              <% if question.required? %>
                <span class="text-red-600 font-medium">Required</span>
              <% end %>
              <% if question.ai_enhanced? %>
                <span class="flex items-center text-purple-600 font-medium">
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                  </svg>
                  AI Enhanced
                </span>
              <% end %>
            </div>
          </div>
          
          <!-- Question Actions -->
          <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button data-action="click->question-card#edit"
                    class="p-1.5 text-gray-400 hover:text-indigo-600 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
            <button data-action="click->question-card#duplicate"
                    class="p-1.5 text-gray-400 hover:text-blue-600 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </button>
            <button data-action="click->question-card#delete"
                    data-confirm="Are you sure you want to delete this question?"
                    class="p-1.5 text-gray-400 hover:text-red-600 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- Question Preview -->
        <% if question.description.present? %>
          <p class="text-sm text-gray-600 mt-2 line-clamp-2">
            <%= question.description %>
          </p>
        <% end %>
        
        <!-- Question Options Preview (for multiple choice, etc.) -->
        <% if question.question_type.in?(['multiple_choice', 'single_choice']) && question.options.present? %>
          <div class="mt-3 space-y-1">
            <% question.options.first(3).each do |option| %>
              <div class="flex items-center space-x-2 text-sm text-gray-600">
                <div class="w-3 h-3 border border-gray-300 rounded <%= 'rounded-full' if question.question_type == 'single_choice' %>"></div>
                <span><%= option %></span>
              </div>
            <% end %>
            <% if question.options.count > 3 %>
              <div class="text-xs text-gray-500 ml-5">
                +<%= question.options.count - 3 %> more options
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Conditional Logic Indicator -->
    <% if question.conditional_logic.present? %>
      <div class="mt-3 pt-3 border-t border-gray-100">
        <div class="flex items-center space-x-2 text-xs text-amber-600">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span>Has conditional logic</span>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<style>
  .bg-ai-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>